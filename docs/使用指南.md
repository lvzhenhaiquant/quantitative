# 量化回测系统使用指南

## 目录

- [1. 系统概述](#1-系统概述)
- [2. 快速开始](#2-快速开始)
- [3. 数据说明](#3-数据说明)
- [4. 因子计算](#4-因子计算)
- [5. 回测运行](#5-回测运行)
- [6. 因子中性化](#6-因子中性化)
- [7. 多因子合成](#7-多因子合成)
- [8. API 参考](#8-api-参考)
- [9. 配置说明](#9-配置说明)

---

## 1. 系统概述

本系统是一个基于 Polars + Numba 的高性能量化因子研究和回测框架。

### 主要功能

| 功能 | 说明 |
|------|------|
| 因子计算 | 支持多种量价、波动率、估值因子 |
| 因子中性化 | 行业 + 市值中性化 |
| 多因子合成 | IC 加权合成 |
| 策略回测 | 多种调仓频率、权重方法 |

### 系统架构

```
quantitative/
├── factor_production/     # 因子生产模块
│   ├── data/              # 数据加载层
│   ├── factors/           # 因子计算函数
│   ├── neutralize.py      # 因子中性化
│   ├── combiner/          # 多因子合成
│   └── cache/             # 因子缓存
├── backtest/              # 回测模块
│   ├── engine.py          # 回测引擎
│   ├── backtester.py      # 回测逻辑
│   ├── weight_optimizer.py # 权重优化
│   └── filters/           # 股票过滤
├── data/                  # 数据目录
└── run_backtest.py        # 命令行入口
```

---

## 2. 快速开始

### 2.1 环境准备

```bash
cd /home/zhenhai1/quantitative
source venv/bin/activate
```

### 2.2 查看可用因子

```bash
python run_backtest.py --list
```

### 2.3 计算因子

```bash
python run_backtest.py --calc volatility
```

### 2.4 运行回测

```bash
# 基本用法
python run_backtest.py -f volatility -d min

# 周度调仓
python run_backtest.py -f volatility -d min -r weekly

# 开启中性化
python run_backtest.py -f volatility -d min -N
```

---

## 3. 数据说明

### 3.1 数据目录结构

```
data/
├── daily/              # 日线行情
├── basic/              # 估值、换手率
├── adj/                # 复权因子
├── index_daily/        # 指数行情
├── index_weight/       # 成分股
└── shenwan/            # 申万行业分类
```

### 3.2 字段说明

| 字段 | 来源 | 说明 |
|------|------|------|
| `$close`, `$open`, `$high`, `$low` | daily/ | 价格 (自动后复权) |
| `$volume`, `$amount` | daily/ | 成交量/成交额 |
| `$pe_ttm`, `$pb` | basic/ | 估值指标 |
| `$turnover_rate_f` | basic/ | 自由流通换手率 |
| `$total_mv`, `$circ_mv` | basic/ | 总市值/流通市值 |

---

## 4. 因子计算

### 4.1 命令行方式

```bash
# 计算因子
python run_backtest.py --calc volatility

# 指定股票池
python run_backtest.py --calc volatility -u csi500

# 查看已计算因子
python run_backtest.py --list
```

### 4.2 Python 方式

```python
from factor_production import DataManager, FactorEngine

dm = DataManager()
engine = FactorEngine(dm)

# 加载数据并计算因子
df = dm.load('csi1000', '2020-01-01', '2026-01-01', ['$close'])
# ... 调用因子计算函数
```

---

## 5. 回测运行

### 5.1 命令行参数

```bash
python run_backtest.py -f <因子> -d <方向> [选项]
```

| 参数 | 说明 | 可选值 |
|------|------|--------|
| `-f, --factor` | 因子名称 | 使用 `--list` 查看 |
| `-d, --direction` | 选股方向 | `min`, `max` |
| `-w, --weight` | 权重方法 | `equal`, `max_sharpe`, `min_vol` |
| `-n` | 选股数量 | 默认 30 |
| `-r, --rebalance` | 调仓频率 | `daily`, `weekly`, `monthly` |
| `-u, --universe` | 股票池 | `csi300`, `csi500`, `csi1000`, `csiall` |
| `-N, --neutralize` | 开启中性化 | - |

### 5.2 示例

```bash
# 月度调仓，等权
python run_backtest.py -f volatility -d min -r monthly

# 周度调仓，最大夏普
python run_backtest.py -f volatility -d min -r weekly -w max_sharpe

# 中证500股票池，开启中性化
python run_backtest.py -f volatility -d min -u csi500 -N
```

### 5.3 权重方法说明

| 方法 | 说明 |
|------|------|
| `equal` | 等权重，简单分散 |
| `max_sharpe` | 最大夏普比率，风险收益最优 |
| `min_vol` | 最小方差，风险最低 |

### 5.4 股票过滤

回测自动排除：
- ST 股票
- 停牌股票
- 涨跌停股票
- 科创板/北交所 (可选)

---

## 6. 因子中性化

### 6.1 中性化原理

使用截面回归消除因子的行业和市值暴露：

```
原始因子 = α + β₁×行业哑变量 + β₂×ln(市值) + ε
中性化因子 = ε (残差)
```

### 6.2 使用方法

```bash
# 命令行
python run_backtest.py -f volatility -d min -N

# Python
result = engine.run('volatility', direction='min', neutralize=True)
```

### 6.3 中性化配置

| 配置 | 默认值 |
|------|--------|
| 行业分类 | 申万2级 (131个行业) |
| 市值指标 | 流通市值 (对数变换) |
| 标准化 | Z-score |

---

## 7. 多因子合成

### 7.1 IC 加权合成

基于历史 IC 对多因子进行加权合成：

```bash
python run_backtest.py -C factor1,factor2,factor3 --date 2025-12-31
```

### 7.2 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-C, --combine` | 因子列表 (逗号分隔) | - |
| `--date` | 目标日期 | 最新交易日 |
| `--ic-window` | IC 计算窗口 | 63 天 |
| `--ret-period` | 收益率周期 | 21 天 |
| `-B, --backtest` | 合成后回测 | - |

### 7.3 示例

```bash
# 合成因子并回测
python run_backtest.py -C turnover_ratio,history_sigma -B -r weekly

# 查看因子权重
python run_backtest.py -C turnover_ratio,history_sigma --date 2025-12-31
```

---

## 8. API 参考

### 8.1 DataManager

```python
from factor_production import DataManager

dm = DataManager()

# 加载数据
df = dm.load(
    stocks='csi1000',      # 股票池
    start='2020-01-01',
    end='2026-01-01',
    fields=['$close', '$volume'],
    adjust=True            # 后复权
)

# 获取成分股
stocks = dm.get_pool_stocks('csi1000', '2020-01-01', '2026-01-01')
```

### 8.2 回测结果

```python
result = engine.run('volatility', direction='min')

# 业绩指标
result['metrics']['total_return']      # 累计收益
result['metrics']['annual_return']     # 年化收益
result['metrics']['sharpe_ratio']      # 夏普比率
result['metrics']['max_drawdown']      # 最大回撤
result['metrics']['information_ratio'] # 信息比率

# 数据
result['portfolio_values']  # 净值序列
result['trades']            # 交易记录
```

---

## 9. 配置说明

### 9.1 默认配置

| 配置项 | 默认值 |
|--------|--------|
| 初始资金 | 1000万 |
| 手续费 | 万3 |
| 印花税 | 千1 (卖出) |
| 滑点 | 千1 |
| 调仓频率 | 月频 |
| 基准指数 | 中证1000 |
| 选股数量 | 30 |

### 9.2 回测结果目录

```
backtest/results/{factor_name}/
├── values.csv          # 净值曲线
├── trades.csv          # 交易记录
├── metrics.csv         # 业绩指标
└── performance.png     # 净值图表
```

---

## 常见问题

### Q1: 因子数据在哪里？

因子缓存在 `factor_production/cache/` 目录下。

### Q2: 如何查看可用因子？

```bash
python run_backtest.py --list
```

### Q3: 回测太慢怎么办？

- 使用等权 (`-w equal`) 代替优化权重
- 减少选股数量 (`-n 20`)
- 缩短回测时间