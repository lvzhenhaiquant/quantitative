# 量化回测系统使用指南

## 目录

- [1. 系统概述](#1-系统概述)
- [2. 快速开始](#2-快速开始)
- [3. 数据说明](#3-数据说明)
- [4. 因子计算](#4-因子计算)
- [5. 回测运行](#5-回测运行)
- [6. 因子中性化](#6-因子中性化)
- [7. API 参考](#7-api-参考)
- [8. 配置说明](#8-配置说明)
- [9. 完整示例](#9-完整示例)

---

## 1. 系统概述

本系统是一个基于 Polars 的量化因子研究和回测框架，直接读取 Parquet 文件，不依赖 QLib。

| 模块 | 功能 | 入口 |
|------|------|------|
| **因子计算** | 计算各类量化因子 | `FactorEngine` |
| **策略回测** | 基于因子的选股回测 | `BacktestEngine` |

### 系统架构

```
quantitative/
├── factor_production/     # 因子生产模块
│   ├── data/              # 数据加载层 (Parquet → Polars)
│   ├── engine/            # 因子计算引擎
│   ├── factors/           # 因子计算函数
│   │   └── amount_ma.py   # 成交额均值因子
│   └── cache/             # 因子缓存 (Parquet)
├── backtest/              # 回测模块
│   ├── engine.py          # 简化版回测引擎
│   ├── backtester.py      # 完整回测逻辑
│   ├── weight_optimizer.py # 权重优化器
│   ├── filters/           # 股票过滤 (ST/停牌/涨跌停)
│   └── results/           # 回测结果
├── data/                  # 数据目录 (Parquet)
│   ├── daily/             # 日线行情
│   ├── basic/             # 估值/换手率
│   ├── adj/               # 复权因子
│   ├── index_daily/       # 指数行情
│   └── index_weight/      # 成分股 (JSON)
└── run_backtest.py        # 命令行入口
```

---

## 2. 快速开始

### 2.1 环境准备

```bash
cd /home/zhenhai1/quantitative
source venv/bin/activate
```

### 2.2 一行代码完成回测

```python
from backtest import BacktestEngine

engine = BacktestEngine()
result = engine.run('amount_ma', direction='min')
```

### 2.3 命令行方式

```bash
# 计算因子
python run_backtest.py --calc amount_ma

# 运行回测
python run_backtest.py --factor amount_ma --direction min --weight equal --n 30
```

---

## 3. 数据说明

### 3.1 数据目录结构

```
data/
├── daily/              # 日线行情 (每股票一个parquet)
│   ├── SZ000001.parquet
│   ├── SH600000.parquet
│   └── ...
├── basic/              # 每日指标
│   └── {stock}.parquet  # pe_ttm, pb, turnover_rate_f, total_mv, ...
├── adj/                # 复权因子
│   └── {stock}.parquet  # factor
├── index_daily/        # 指数行情
│   ├── SH000300.parquet  # 沪深300
│   ├── SH000852.parquet  # 中证1000
│   └── ...
└── index_weight/       # 成分股 (JSON格式)
    ├── csi300.json
    ├── csi500.json
    ├── csi1000.json
    └── csiall.json
```

### 3.2 字段映射

| 字段 | 来源 | 说明 |
|------|------|------|
| `$close`, `$open`, `$high`, `$low` | daily/ | 价格数据 (自动后复权) |
| `$volume`, `$amount` | daily/ | 成交量/成交额 |
| `$pe_ttm`, `$pb` | basic/ | 估值指标 |
| `$turnover_rate_f` | basic/ | 自由流通换手率 |
| `$total_mv`, `$circ_mv` | basic/ | 总市值/流通市值 |
| `$factor` | adj/ | 复权因子 |

### 3.3 成分股数据格式

`index_weight/csi1000.json`:
```json
{
  "2024-01-31": ["SZ000001", "SH600000", ...],
  "2024-02-29": ["SZ000001", "SH600000", ...],
  ...
}
```

---

## 4. 因子计算

### 4.1 因子说明

| 因子名称 | 说明 | 所需字段 | 推荐方向 |
|----------|------|----------|----------|
| `amount_ma` | 6日成交额均值 | `$amount` | min |

**因子逻辑**: 计算过去6个交易日的成交额均值，选择成交额较低的股票。低成交额往往意味着市场关注度较低，可能存在价值低估的机会。

### 4.2 计算因子 - Python方式

```python
from factor_production import DataManager, FactorEngine
from factor_production.factors import calc_amount_ma

# 初始化
dm = DataManager()
engine = FactorEngine(dm, cache_dir='/home/zhenhai1/quantitative/factor_production/cache')

# 计算因子
result = engine.run(
    factor_func=calc_amount_ma,    # 因子计算函数
    stocks='csi1000',              # 股票池: csi1000/csi500/csi300/csiall
    start='2020-01-01',            # 开始日期
    end='2025-12-30',              # 结束日期
    fields=['$amount'],            # 所需字段
    window=6                       # 滚动窗口
)
```

### 4.3 计算因子 - 命令行方式

```bash
# 计算成交额均值因子
python run_backtest.py --calc amount_ma

# 指定股票池
python run_backtest.py --calc amount_ma --universe csi500
```

### 4.4 查看已计算的因子

```bash
python run_backtest.py --list
```

---

## 5. 回测运行

### 5.1 使用 BacktestEngine (推荐)

```python
from backtest import BacktestEngine

engine = BacktestEngine()

# 运行回测
result = engine.run(
    factor='amount_ma',       # 因子名称 (必填)
    direction='min',          # 选股方向 (必填)
    weight='equal',           # 权重方法 (可选，默认 equal)
    n_stocks=30,              # 选股数量 (可选，默认 30)
    universe='csi1000',       # 股票池 (可选，默认 csi1000)
    benchmark='sh000852',     # 基准指数 (可选，默认 中证1000)
    start_date='2021-01-01',  # 回测起始日期 (可选)
    neutralize=False,         # 因子中性化 (可选)
    show_plot=True            # 是否显示图表 (可选)
)
```

### 5.2 参数详解

#### `direction` - 选股方向

| 值 | 说明 | 适用因子 |
|----|------|----------|
| `'min'` | 选因子值**最小**的股票 | amount_ma (低成交额) |
| `'max'` | 选因子值**最大**的股票 | 动量因子等 |

#### `weight` - 权重方法

| 值 | 说明 | 优点 | 缺点 |
|----|------|------|------|
| `'equal'` | 等权重 | 简单、分散 | 不考虑风险 |
| `'max_sharpe'` | 最大夏普比率 | 风险收益最优 | 计算复杂、可能集中 |
| `'min_vol'` | 最小方差 | 风险最低 | 收益可能偏低 |

#### `universe` - 股票池

| 代码 | 名称 |
|------|------|
| `'csi1000'` | 中证1000 (默认) |
| `'csi500'` | 中证500 |
| `'csi300'` | 沪深300 |
| `'csiall'` | 中证全指 |

#### `benchmark` - 基准指数

| 代码 | 名称 |
|------|------|
| `'sh000852'` | 中证1000 (默认) |
| `'sh000300'` | 沪深300 |
| `'sh000905'` | 中证500 |

### 5.3 命令行方式

```bash
# 基本用法
python run_backtest.py --factor amount_ma --direction min

# 完整参数
python run_backtest.py \
    --factor amount_ma \
    --direction min \
    --weight max_sharpe \
    --n 50 \
    --universe csi1000

# 简写形式
python run_backtest.py -f amount_ma -d min -w equal -n 30

# 查看帮助
python run_backtest.py --help
```

### 5.4 对比不同配置

```python
engine = BacktestEngine()

# 对比 min/max 方向 和 equal/max_sharpe 权重
df = engine.compare(
    factor='amount_ma',
    directions=['min', 'max'],
    weights=['equal', 'max_sharpe'],
    n_stocks=30
)

print(df)
```

### 5.5 股票过滤

回测自动排除以下股票：
- **ST股票**: 带有 ST、*ST 标记的股票
- **停牌股票**: 当日停牌无法交易
- **涨跌停股票**: 涨停无法买入，跌停无法卖出
- **科创板/北交所**: 可选排除 (默认排除)

---

## 6. 因子中性化

因子中性化用于消除因子对行业和市值的暴露，使因子更加"纯净"。

### 6.1 中性化原理

使用截面回归法：

```
原始因子 = α + β₁×行业哑变量 + β₂×ln(市值) + ε
中性化因子 = ε (残差)
```

通过回归消除行业和市值效应后，残差即为中性化后的因子值。

### 6.2 使用方法

#### 命令行方式

```bash
# 使用 -N 或 --neutralize 开启中性化
python run_backtest.py -f amount_ma -d min -N
python run_backtest.py -f amount_ma -d min -w max_sharpe --neutralize
```

#### Python API

```python
from backtest import BacktestEngine

engine = BacktestEngine()

# 开启中性化
result = engine.run(
    factor='amount_ma',
    direction='min',
    weight='equal',
    n_stocks=30,
    neutralize=True    # 开启中性化
)
```

### 6.3 中性化配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 行业分类 | 申万2级 | 131个行业 |
| 市值指标 | 流通市值 (circ_mv) | 对数变换后使用 |
| 标准化 | 开启 | 残差进行Z-score标准化 |

---

## 7. API 参考

### 7.1 DataManager

```python
class DataManager:
    """数据管理器 - 从 Parquet 加载数据"""

    def load(self,
             stocks: str | List[str],  # 股票池或股票列表
             start: str,                # 开始日期
             end: str,                  # 结束日期
             fields: List[str],         # 字段列表
             adjust: bool = True        # 是否后复权
    ) -> pl.DataFrame:
        """加载股票数据"""
        pass

    def get_pool_stocks(self,
                        pool: str,      # 股票池名称
                        start: str,     # 开始日期
                        end: str        # 结束日期
    ) -> List[str]:
        """获取时间范围内的成分股"""
        pass

    def get_pool_stocks_by_date(self,
                                pool: str,   # 股票池名称
                                date: str    # 指定日期
    ) -> List[str]:
        """获取指定日期的成分股"""
        pass
```

### 7.2 BacktestEngine

```python
class BacktestEngine:
    """简化版回测引擎"""

    def run(self,
            factor: str,                           # 因子名称
            direction: Literal['min', 'max'],      # 选股方向
            weight: str = 'equal',                 # 权重方法
            n_stocks: int = 30,                    # 选股数量
            universe: str = 'csi1000',             # 股票池
            benchmark: str = 'sh000852',           # 基准指数
            start_date: str = '2021-01-01',        # 起始日期
            neutralize: bool = False,              # 因子中性化
            show_plot: bool = True                 # 是否画图
    ) -> Dict:
        """运行回测，返回结果字典"""
        pass

    def list_factors(self) -> list:
        """列出所有可用因子"""
        pass

    def compare(self,
                factor: str,
                directions: list,
                weights: list,
                n_stocks: int = 30
    ) -> pd.DataFrame:
        """对比不同配置的回测结果"""
        pass
```

### 7.3 回测结果结构

```python
result = engine.run('amount_ma', direction='min')

# result 包含以下字段:
result['metrics']           # 业绩指标 (dict)
result['portfolio_values']  # 净值序列 (DataFrame)
result['trades']            # 交易记录 (DataFrame)
result['positions']         # 持仓记录 (DataFrame)

# metrics 包含:
result['metrics']['total_return']       # 累计收益率
result['metrics']['annual_return']      # 年化收益率
result['metrics']['benchmark_return']   # 基准收益率
result['metrics']['excess_return']      # 超额收益率
result['metrics']['volatility']         # 年化波动率
result['metrics']['sharpe_ratio']       # 夏普比率
result['metrics']['max_drawdown']       # 最大回撤
result['metrics']['information_ratio']  # 信息比率
result['metrics']['calmar_ratio']       # 卡玛比率
result['metrics']['win_rate']           # 胜率
```

---

## 8. 配置说明

### 8.1 默认配置

```python
DEFAULT_CONFIG = {
    'initial_cash': 10_000_000,        # 初始资金: 1000万
    'backtest_start_date': '2021-01-01',

    # 交易成本
    'transaction': {
        'commission_rate': 0.0003,     # 手续费: 万3
        'min_commission': 5,           # 最小手续费: 5元
        'stamp_tax': 0.001,            # 印花税: 千1 (仅卖出)
        'slippage': 0.001,             # 滑点: 千1
    },

    # 风险控制
    'risk': {
        'max_position': 0.10,          # 单只股票最大仓位: 10%
    },

    # 调仓频率
    'rebalance': {
        'freq': 'monthly'              # 月频调仓
    }
}
```

### 8.2 自定义配置

如需更详细的配置，可直接使用底层 `Backtester` 类：

```python
from backtest.backtester import Backtester
from utils.data_loader import DataLoader

config = {
    'initial_cash': 5_000_000,
    'backtest_start_date': '2022-01-01',
    'selection': {
        'method': 'top_n',
        'n_stocks': 50,
        'ascending': True
    },
    'weighting': {
        'method': 'max_sharpe',
        'lookback_days': 252,
        'max_weight': 0.05,
        'use_dynamic_rf': True     # 使用动态SHIBOR
    },
    'rebalance': {'freq': 'monthly'},
    'benchmark': {'code': 'sh000300'}
}

data_loader = DataLoader()
backtester = Backtester(config, data_loader)
result = backtester.run('amount_ma', factor_data)
```

---

## 9. 完整示例

### 9.1 示例: 低成交额策略

```python
"""
策略: 选择成交额最低的30只股票，等权持有，月频调仓
"""
from factor_production import DataManager, FactorEngine
from factor_production.factors import calc_amount_ma
from backtest import BacktestEngine

# Step 1: 计算成交额均值因子
dm = DataManager()
factor_engine = FactorEngine(dm, cache_dir='/home/zhenhai1/quantitative/factor_production/cache')

factor_engine.run(
    factor_func=calc_amount_ma,
    stocks='csi1000',
    start='2020-01-01',
    end='2025-12-30',
    fields=['$amount'],
    window=6
)

# Step 2: 运行回测
backtest_engine = BacktestEngine()
result = backtest_engine.run(
    factor='amount_ma',
    direction='min',      # 选成交额最小的
    weight='equal',
    n_stocks=30
)

# Step 3: 查看结果
print(f"年化收益: {result['metrics']['annual_return']:.2%}")
print(f"夏普比率: {result['metrics']['sharpe_ratio']:.2f}")
print(f"最大回撤: {result['metrics']['max_drawdown']:.2%}")
```

### 9.2 示例: 策略对比

```python
"""
对比低成交额 vs 高成交额、等权 vs 最大夏普
"""
from backtest import BacktestEngine

engine = BacktestEngine()

# 对比不同配置
comparison = engine.compare(
    factor='amount_ma',
    directions=['min', 'max'],
    weights=['equal', 'max_sharpe'],
    n_stocks=30
)

print("\n=== 策略对比结果 ===")
print(comparison.to_string(index=False))
```

### 9.3 示例: 命令行测试

```bash
#!/bin/bash

# 计算因子
python run_backtest.py --calc amount_ma

# 测试不同方向和权重
for direction in min max; do
    for weight in equal max_sharpe; do
        echo "Testing: $direction + $weight"
        python run_backtest.py -f amount_ma -d $direction -w $weight -n 30
    done
done
```

---

## 附录: 常见问题

### Q1: 因子数据在哪里？

因子数据保存在 `/home/zhenhai1/quantitative/factor_production/cache/` 目录下，格式为 `{factor_name}_{start}_{end}.parquet`

### Q2: 回测结果在哪里？

回测结果保存在 `/home/zhenhai1/quantitative/backtest/results/` 目录下，包括：
- `{factor}_values.csv` - 净值曲线
- `{factor}_trades.csv` - 交易记录
- `{factor}_metrics.csv` - 业绩指标
- `{factor}_performance.png` - 净值图表

### Q3: 如何添加新因子？

1. 在 `factor_production/factors/` 目录下创建新文件
2. 定义因子计算函数，签名为 `def calc_xxx(df: pl.DataFrame, ...) -> pl.DataFrame`
3. 在 `factor_production/factors/__init__.py` 中导出
4. 在 `run_backtest.py` 中的 `FACTOR_MAP` 添加配置

### Q4: 回测跑太慢怎么办？

- 减少选股数量 (`n_stocks`)
- 使用等权 (`weight='equal'`) 代替优化权重
- 缩短回测时间范围 (`start_date`)

---

*文档更新时间: 2025-12-30*
